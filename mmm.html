@extends('client.layouts.app')

@section('content')



    <!-- catg header banner section -->
 @include('client.components.hero')
    <!-- / catg header banner section -->

    <!-- Cart view section -->
    <section id="checkout">
        <div class="container">
            <div class="row">
                <div class="col-md-12">

                    <div class="checkout-area">
                        @include('client.components.massege')
                        @include('client.components.errorMassage')
                        <div class="row">
                            @guest
                            <div class="row">
                                <div class="col-md-8">
                                    <form action="{{route('client.processOrder')}}" method="post">
                                        @csrf
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="aa-checkout-single-bill">
                                                <input type="text" placeholder="Name*"
                                                    value=""
                                                    name="customer_name">
                                            </div>
                                        </div>
        
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="aa-checkout-single-bill">
                                                <input type="tel" placeholder="Phone*"
                                                    name="customer_phone_number"
                                                    value="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="aa-checkout-single-bill">
                                                <textarea cols="8" rows="3"
                                                    name="address" placeholder="Address*"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="aa-checkout-single-bill">
                                                <select name="country">
                                                    <option value="Span" selected>Span</option>
                                                    <option value="Bangladesh">Bangladesh</option>
                                                    <option value="China">China</option>
                                                    <option value="India">India</option>
                                                    <option value="Canada">Canada</option>
                                                    <option value="UAE">UAE</option>
                                                    <option value="UK">UK</option>
                                                    <option value="USA">USA</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="aa-checkout-single-bill">
                                                <input type="text" placeholder="City / Town*"
                                                    name="city" value="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="aa-checkout-single-bill">
                                                <input type="text" placeholder="District*"
                                                    name="district" value="">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="aa-checkout-single-bill">
                                                <input type="text" placeholder="Postcode / ZIP*"
                                                    name="postal_code" value="">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="checkout-right">
                                        <h4>Order Summary</h4>
                                        <div class="aa-order-summary-area">
                                            <table class="table table-responsive">
                                                <thead>
                                                    <tr>
                                                        <th>Product</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach ($cart as $key => $product)

                                                        <tr>
                                                            <td>
                                                                {{ $product['title'] }} <strong> ({{ $product['main_price'] }}x {{ $product['quantity'] }})</strong>
                                                            </td>
                                                            <td>
                                                                &#2547;  {{  number_format($product['main_price'] * $product['quantity'],2)  }}
                                                            </td>
                                                        </tr>
                                                    @endforeach

                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <th>Total Price</th>
                                                        <td>&#2547;  {{ number_format($total_main_price, 2)}}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Total Discount</th>
                                                        <td>&#2547;  {{ number_format($total_discount, 2)}}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Subtotal (After Discount)</th>
                                                        <td>&#2547;  {{ number_format($total, 2)}}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Tax</th>
                                                        <td>&#2547;  {{ number_format($total_tax, 2)}}</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Delivery Charge</th>
                                                        <td>&#2547;  {{ number_format($total_delivery_charge, 2) }}</td>
                                                    </tr>

                                                    <tr>
                                                        <th>Total Paid Amount</th>
                                                        <td>&#2547;  {{ number_format( $total+ $total_tax + $total_delivery_charge , 2) }}</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                        <h4>Payment Method</h4>
                                        <div class="aa-payment-method">
                                            <label for="cashdelivery">
                                                <input type="radio" id="cashdelivery" checked   value="cashdelivery" name="payment_details"> Cash on Delivery
                                            </label>
                                            <label for="paypal">
                                                <input type="radio" id="paypal"  value="paypal" name="payment_details"> Via Paypal
                                            </label>
                                            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/AM_mc_vs_dc_ae.jpg"
                                                border="0" alt="PayPal Acceptance Mark">

                                            @IF($total>0)
                                            <input type="submit" value="Place Order" class="aa-browse-btn">
                                            @ELSE
                                             <input readonly type="text"  value="Your Cart is empty" class="aa-browse-btn">
                                            @ENDIF
                                        </div>
                                    </div>
                                </div>
                            </div>
                           
                            @IF($total>0)
                            <input type="submit" value="Place Order" class="aa-browse-btn">
                            @ELSE
                             <input readonly type="text"  value="Your Cart is empty" class="aa-browse-btn">
                            @ENDIF
                        </div>
                    </div>
                </div>
            </div>
        </form>
                            @endguest
                            @auth
                                <div class="col-md-12">
                                    <h1>You ordering as {{ auth()->user()->name }} </a></h1>
                                </div>
                            @endauth

                        </div>
                        @auth()


                            <form action="{{route('client.processOrder')}}" method="post">
                                @csrf
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="checkout-left">
                                            <div class="panel-group" id="accordion">
                                                <!-- Billing Details -->
                                                <div class="panel panel-default aa-checkout-billaddress">
                                                    <div class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a data-toggle="collapse" data-parent="#accordion"
                                                                href="#collapseOne">
                                                                Billing Details
                                                            </a>
                                                        </h4>
                                                    </div>
                                                    <div id="collapseOne" class="panel-collapse collapse in">
                                                        <div class="panel-body">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="Name*"
                                                                            value="{{ auth()->user()->name }}"
                                                                            name="customer_name">
                                                                    </div>
                                                                </div>

                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="tel" placeholder="Phone*"
                                                                            name="customer_phone_number"
                                                                            value="{{ auth()->user()->phone_number }}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <textarea cols="8" rows="3"
                                                                            name="address" placeholder="Address*">{{ auth()->user()->address }}</textarea>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <select name="country">
                                                                            <option value="Span" selected>Span</option>
                                                                            <option value="Bangladesh">Bangladesh</option>
                                                                            <option value="China">China</option>
                                                                            <option value="India">India</option>
                                                                            <option value="Canada">Canada</option>
                                                                            <option value="UAE">UAE</option>
                                                                            <option value="UK">UK</option>
                                                                            <option value="USA">USA</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="City / Town*"
                                                                            name="city" value="{{ auth()->user()->city }}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="District*"
                                                                            name="district" value="{{ auth()->user()->district }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="Postcode / ZIP*"
                                                                            name="postal_code" value="{{ auth()->user()->postal_code}}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Shipping Address -->
                                                <div class="panel panel-default aa-checkout-billaddress">
                                                    <div class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a data-toggle="collapse" data-parent="#accordion"
                                                                href="#collapseFour">
                                                                Shippping Address
                                                            </a>
                                                        </h4>
                                                    </div>
                                                    <div id="collapseFour" class="panel-collapse collapse">
                                                        <div class="panel-body">
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="Name*" value=""
                                                                            name="shipping_customer_name">
                                                                    </div>
                                                                </div>

                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="tel" placeholder="Phone*"
                                                                            name="shipping_customer_phone_number">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <textarea cols="8" rows="3"
                                                                            name="shipping_address" placeholder="Shipping Address*"></textarea>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <select name="shipping_country">
                                                                            <option value="Span" selected>Span</option>
                                                                            <option value="Bangladesh">Bangladesh</option>
                                                                            <option value="China">China</option>
                                                                            <option value="India">India</option>
                                                                            <option value="Canada">Canada</option>
                                                                            <option value="UAE">UAE</option>
                                                                            <option value="UK">UK</option>
                                                                            <option value="USA">USA</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="City / Town*"
                                                                            name="shipping_city">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="District*"
                                                                            name="shipping_district">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="aa-checkout-single-bill">
                                                                        <input type="text" placeholder="Postcode / ZIP*"
                                                                            name="shipping_postal_code">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="checkout-right">
                                            <h4>Order Summary</h4>
                                            <div class="aa-order-summary-area">
                                                <table class="table table-responsive">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach ($cart as $key => $product)

                                                            <tr>
                                                                <td>
                                                                    {{ $product['title'] }} <strong> ({{ $product['main_price'] }}x {{ $product['quantity'] }})</strong>
                                                                </td>
                                                                <td>
                                                                    &#2547;  {{  number_format($product['main_price'] * $product['quantity'],2)  }}
                                                                </td>
                                                            </tr>
                                                        @endforeach

                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <th>Total Price</th>
                                                            <td>&#2547;  {{ number_format($total_main_price, 2)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Total Discount</th>
                                                            <td>&#2547;  {{ number_format($total_discount, 2)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Subtotal (After Discount)</th>
                                                            <td>&#2547;  {{ number_format($total, 2)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Tax</th>
                                                            <td>&#2547;  {{ number_format($total_tax, 2)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Delivery Charge</th>
                                                            <td>&#2547;  {{ number_format($total_delivery_charge, 2) }}</td>
                                                        </tr>

                                                        <tr>
                                                            <th>Total Paid Amount</th>
                                                            <td>&#2547;  {{ number_format( $total+ $total_tax + $total_delivery_charge , 2) }}</td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                            <h4>Payment Method</h4>
                                            <div class="aa-payment-method">
                                                <label for="cashdelivery">
                                                    <input type="radio" id="cashdelivery" checked   value="cashdelivery" name="payment_details"> Cash on Delivery
                                                </label>
                                                <label for="paypal">
                                                    <input type="radio" id="paypal"  value="paypal" name="payment_details"> Via Paypal
                                                </label>
                                                <img src="https://www.paypalobjects.com/webstatic/mktg/logo/AM_mc_vs_dc_ae.jpg"
                                                    border="0" alt="PayPal Acceptance Mark">

                                                @IF($total>0)
                                                <input type="submit" value="Place Order" class="aa-browse-btn">
                                                @ELSE
                                                 <input readonly type="text"  value="Your Cart is empty" class="aa-browse-btn">
                                                @ENDIF
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <div class="cart-view-total" style="margin:0px auto; display:block; width:auto; float:left;">
                                <a href="{{ route('client.shop') }}" class="aa-cart-view-btn"
                                    style="background-color:#FF6666 !important;">Continue Shoping</a>
                            </div>
                        @endauth
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- / Cart view section -->
@endsection





















<?php

namespace App\Http\Controllers\client;

use App\Http\Controllers\Controller;
use App\Models\Orders;
use App\Models\OrderProducts;
use App\Models\product_table;
use App\Notifications\orderConfirmNotification;
use Dotenv\Exception\ValidationException;
use Illuminate\Contracts\Session\Session;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;


class cartController extends Controller
{
    public function showCart()
    {
        $data = [];

        $data['cart'] = session()->has('cart') ? session()->get('cart') : [];
        $data['total']= array_sum( array_column($data['cart'], 'total_price'));
        $data['total_tax']= array_sum( array_column($data['cart'], 'total_tax'));
        $data['total_delivery_charge']= array_sum( array_column($data['cart'], 'total_delivery_charge'));
        $data['total_discount']= array_sum( array_column($data['cart'], 'total_discount'));
        $data['total_main_price']= array_sum( array_column($data['cart'], 'total_main_price'));
        
        return view('client.pages.cart', $data);
    }

    public function cartData()
    {
        $data = [];

        $data['cart'] = session()->has('cart') ? session()->get('cart') : [];
        $data['total']= array_sum( array_column($data['cart'], 'total_price'));
        $data['total_tax']= array_sum( array_column($data['cart'], 'total_tax'));
        $data['total_delivery_charge']= array_sum( array_column($data['cart'], 'total_delivery_charge'));
        $data['total_discount']= array_sum( array_column($data['cart'], 'total_discount'));
        $data['total_main_price']= array_sum( array_column($data['cart'], 'total_main_price'));
        dd($data);
        return $data;
    }

    public function addToCart(Request $request)
    {

       
        
        $cart=[];

        try {
            $this->validate($request, [
                'product_id' => 'required|numeric',
            ]);
        } catch (ValidationException $e) {
            return redirect()->back();
        }

         $product = product_table::with('img','color')->findOrFail($request->input('product_id'));
         $unit_price=($product->product_selling_price !== null && $product->product_selling_price > 0) ? $product->product_selling_price : $product->product_price;
         $total_discount=$product->product_price-$unit_price;
         $main_price=$product->product_price;

         $cart = session()->has('cart') ? session()->get('cart') : [];

        $quantity= $request->quantity ?? $product->product_quantity;
        $color =$request->color;
        $meserment =$request->meserment;
      
        $product_tax=($unit_price*$product->product_tax)/100;

        $product_delivary_charge=$quantity*$product->product_delivary_charge;

        if (array_key_exists($product->id, $cart)) {
            $cart[$product->id]['quantity'] +=  $quantity;
            $cart[$product->id]['total_main_price']= $cart[$product->id]['quantity'] *  $cart[$product->id]['main_price'];
            $cart[$product->id]['total_discount']= $cart[$product->id]['quantity'] *  $cart[$product->id]['discount'];
            $cart[$product->id]['total_price']= $cart[$product->id]['quantity'] *  $cart[$product->id]['unit_price'];
            $cart[$product->id]['total_tax']= $cart[$product->id]['quantity'] *  $cart[$product->id]['product_tax'];

            if ($product->product_delivary_charge_type != 0) {
                $cart[$product->id]['total_delivery_charge']= $cart[$product->id]['quantity'] *  $cart[$product->id]['product_delivary_charge'];
            }


        } else {
            $cart[$product->id] = [

                'title' => $product->product_title,
                'quantity' => $quantity,
                'main_price' => $main_price,
                'total_main_price' => $main_price,
                'unit_price' => $unit_price,
                'total_price' => $unit_price,
                'discount' => $total_discount,
                'total_discount' => $total_discount,
                'color' =>$color,
                'maserment' =>$meserment,
                'image'=>$product->img[0]->image_path,
                'product_tax' =>$product_tax,
                'total_tax' =>$product_tax,
                'product_delivary_charge' =>$product_delivary_charge,
                'total_delivery_charge' =>$product_delivary_charge,
                'product_delivary_charge_type' =>$product->product_delivary_charge_type,
            ];


        }
   
       session(['cart' => $cart]);
       
        if ( count($cart)>0) {
            return 1;

        } else {
            return 0;
        }

       

    }

    public function cartUpdate(Request $request){
        try {
            $this->validate($request, [
                'product_update_id' => 'required|numeric',
            ]);
        } catch (ValidationException $e) {
            return redirect()->back();
        }
        $product = product_table::with('img','color')->findOrFail($request->input('product_update_id'));
        

         $cart = session()->has('cart') ? session()->get('cart') : [];

        $quantity= $request->quantity ?? $product->product_quantity;
       

        if (array_key_exists($product->id, $cart)) {
            $cart[$product->id]['quantity'] =  $quantity;
            $cart[$product->id]['total_main_price']= $cart[$product->id]['quantity'] *  $cart[$product->id]['main_price'];
            $cart[$product->id]['total_discount']= $cart[$product->id]['quantity'] *  $cart[$product->id]['discount'];
            $cart[$product->id]['total_price']= $cart[$product->id]['quantity'] *  $cart[$product->id]['unit_price'];
            $cart[$product->id]['total_tax']= $cart[$product->id]['quantity'] *  $cart[$product->id]['product_tax'];

            if ($product->product_delivary_charge_type != 0) {
                $cart[$product->id]['total_delivery_charge']= $cart[$product->id]['quantity'] *  $cart[$product->id]['product_delivary_charge'];
            }  
        }

        session(['cart' => $cart]);

        return redirect()->back()->with('success','Cart Updated');
    }

    public function RemoveFromCart(Request $request)
    {


        try {
            $this->validate($request, [
                'product_id' => 'required|numeric',
            ]);
        } catch (ValidationException $e) {
            return redirect()->back();
        }


        $cart = session()->has('cart') ? session()->get('cart') : [];
        unset($cart[$request->input('product_id')]);
       session(['cart' => $cart]);

       return redirect()->back()->with('success','Remove Success');
    }


    public function clearCart()
    {
       
       session()->forget(['cart']);

        return redirect()->back()->with('success','Your Cart is Clear');
    }


    public function checkout()
    {

        $data = [];
        $data['cart'] = session()->has('cart') ? session()->get('cart') : [];
        $data['total']= array_sum( array_column($data['cart'], 'total_price'));
        $data['total_tax']= array_sum( array_column($data['cart'], 'total_tax'));
        $data['total_delivery_charge']= array_sum( array_column($data['cart'], 'total_delivery_charge'));
        $data['total_discount']= array_sum( array_column($data['cart'], 'total_discount'));
        $data['total_main_price']= array_sum( array_column($data['cart'], 'total_main_price'));

       return view('client.pages.checkout', $data);
    }
    public function order(Request $request)
    {

        $cart = session()->has('cart') ? session()->get('cart') : [];
        $total= array_sum( array_column($cart, 'total_price'));

        $total_tax= array_sum( array_column($cart, 'total_tax'));
        $total_delivery_charge= array_sum( array_column($cart, 'total_delivery_charge'));

        $total_discount= array_sum( array_column($cart, 'total_discount'));
        $total_main_price= array_sum( array_column($cart, 'total_main_price'));

                $customer_name = $request->Input('customer_name');
                $customer_phone_number = $request->Input('customer_phone_number');
                $address =$request->Input('address');
                $country = $request->Input('country');
                $city = $request->Input('city');
                $district = $request->Input('district');
                $postal_code = $request->Input('postal_code');
                $payment_details = $request->Input('payment_details');

                $shipping_customer_name = $request->Input('shipping_customer_name');
                $shipping_customer_phone_number = $request->Input('shipping_customer_phone_number');
                $shipping_address =$request->Input('shipping_address');
                $shipping_country = $request->Input('shipping_country');
                $shipping_city = $request->Input('shipping_city');
                $shipping_district = $request->Input('shipping_district');
                $shipping_postal_code = $request->Input('shipping_postal_code');


              if (isset($shipping_address)) {
                $validator=Validator::make(request()->all(),[
                    'shipping_customer_name'=>'required',
                    'shipping_customer_phone_number'=>'required |min:8| max:16|',
                    'shipping_address'=>'required',
                    'shipping_country'=>'required',
                    'shipping_city'=>'required',
                    'shipping_district'=>'required',
                    'shipping_postal_code'=>'required',

                   ]);

                   if ($validator->fails()) {
                      return redirect()->back()->withErrors($validator);
                    }
                $order=new Orders();
                $order->user_id=auth()->user()->id;
                $order->customer_name=$shipping_customer_name;
                $order->customer_phone_number=$shipping_customer_phone_number;
                $order->address=$shipping_address;
                $order->country= $shipping_country;
                $order->city= $shipping_city;
                $order->district= $shipping_district;
                $order->postal_code= $shipping_postal_code;
                $order->total_tax= $total_tax;
                $order->total_delivery_charge= $total_delivery_charge;
                $order->price_without_discount= $total_main_price;
                $order->discount_amount= $total_discount;
                $order->total_amount= $total;
                $order->paid_amount= $total+$total_tax+$total_delivery_charge;
                $order->payment_details= $payment_details;
                $order->save();
              }else {
                $validator=Validator::make(request()->all(),[
                    'customer_name'=>'required',
                    'customer_phone_number'=>'required |min:8| max:16|',
                    'address'=>'required',
                    'country'=>'required',
                    'city'=>'required',
                    'district'=>'required',
                    'postal_code'=>'required',

                   ]);

                   if ($validator->fails()) {
                      return redirect()->back()->withErrors($validator);
                    }
                $user_id="";
                if (auth()->user()) {
                    $user_id=auth()->user()->id ;
                }else{
                    $user_id=0;
                }


                $order=new Orders();
                $order->user_id=$user_id;
                $order->customer_name=$customer_name;
                $order->customer_phone_number=$customer_phone_number;
                $order->address=$address;
                $order->country= $country;
                $order->city= $city;
                $order->district= $district;
                $order->postal_code= $postal_code;
                $order->total_tax= $total_tax;
                $order->total_delivery_charge= $total_delivery_charge;
                $order->price_without_discount= $total_main_price;
                $order->discount_amount= $total_discount;
                $order->total_amount= $total;
                $order->paid_amount= $total+$total_tax+$total_delivery_charge;
                $order->payment_details= $payment_details;
                $order->save();
              }

        foreach ($cart as $product_id => $product)
        {
            $order_product=new OrderProducts();
            $order_product->product_id=$product_id;
            $order_product->quantity=$product['quantity'];
            $order_product->price=$product['total_price'];
            $order_product->color=$product['color'];
            $order_product->maserment=$product['maserment'];
            $order_product->order_id= $order->id;
            $order_product->save();

        }
        if ($user_id!=0) {
            auth()->user()->notify(new orderConfirmNotification($order));
        }

        session()->forget(['cart','price']);

        return redirect()->route('client.orderDetails', $order->id )->with('success','Order send successfully');

    }

    public function orderDetails($id)
    {
        $data=[];
        $data['orders']=Orders::with('product')->findOrFail($id);
        return view('client.pages.orderDetails', $data);
    }


}




















@extends('client.layouts.app')
@section('css')

<style>
.profile{
    margin: 20px 0px!important;
}
.profile-link{
    position: fixed;
    top: 200px;
    right: 5px;
    background-color:#FF6666;
    color:#fff;
    padding: 10px;
    border-radius: 20px;
    display: inline-block;
    animation-name: profile-link;
    animation-duration: 2s;
    animation-iteration-count: infinite;
    }
    @keyframes profile-link {
  0%   {background-color: red;}
  50%  {background-color: #FF6666;}
  100% {background-color: rgb(228, 122, 23);}
}

</style>

@endsection

@section('content')
    <div class="container">
        <div class="col-md-10 offset-md-1">
            @auth 
            <a class="profile-link" href="{{route('client.profile')}}">Go Your Profile</a>
            @endauth
            <h2 class=" profile  text-center">Order id: {{ $orders->id }}</h2>
            @include('client.components.massege')
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>

                        <th>Title</th>
                        <th>Details</th>

                    </tr>
                </thead>
                <tbody>

                    @foreach ($orders->toArray() as $column => $value)
                    @if (is_string($value))

                    @if($column=='user_id') @continue
                    @elseif ($column=='id') @continue
                    @elseif ($column=='order_product_id') @continue
                    @elseif ($column=='product_owner_id') @continue
                    @endif

                        <tr>

                            <td>{{ucwords(str_replace('_',' ', $column))}}</td>
                            <td>{{$value}}</td>
                        </tr>
                    @endif
                    @endforeach

                </tbody>
            </table>
        </div>
        <div class="col-md-10 offset-md-1">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>

                        <th class="text-center">Product Title</th>
                        <th class="text-center">Quantity</th>
                        <th class="text-center">Color</th>
                        <th class="text-center">Maserment</th>
                        <th class="text-center">Total Price</th>

                    </tr>
                </thead>
                <tbody>

                    @foreach ($orders->product as $product)
                    @if($product->product)
                        <tr>
                            <td class="text-center">{{$product->product->product_title}}</td>
                            <td class="text-center">{{$product->quantity}}</td>

                            <td style="display:flex; justify-content:center; align-items: center;">
                                @if($product->color)

                               <div style=" width:20px; height:20px; border:1px solid #000; border-radius:50%; background-color: {{$product->color}};"></div>
                                @else
                                {{"N/A"}}
                            @endif

                            </td>
                            <td class="text-center">@if($product->maserment)
                               {{$product->maserment}}
                                @else
                                {{"N/A"}}
                            @endif</td>
                            <td class="text-center">&#2547;  {{number_format($product->price, 2)}}</td>
                        </tr>
                        @endif
                    @endforeach
                </tbody>
            </table>
        </div>
    </div>
@endsection
